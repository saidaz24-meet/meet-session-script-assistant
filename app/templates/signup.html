{% extends "base.html" %}
{% block content %}
<h2>Sign up</h2>
<form id="signupForm" onsubmit="return false;">
  <p><input id="name" type="text" placeholder="Full name" required></p>
  <p><input id="email" type="email" placeholder="Email" required></p>
  <p><input id="password" type="password" placeholder="Password" required></p>
  <button class="button" id="signupBtn">Create account</button>
</form>
<p class="muted">Have an account? <a href="{{ url_for('auth.login_page') }}">Sign in</a></p>

<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "{{ fb_api_key }}",
    authDomain: "{{ fb_auth_domain }}",
    projectId: "{{ fb_project_id }}",
    appId: "{{ fb_app_id }}",
    messagingSenderId: "{{ fb_sender_id }}"
  };
  
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }

  const auth = firebase.auth();

  document.getElementById("signupBtn").addEventListener("click", async () => {
    const name = document.getElementById("name").value.trim();
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    
    if (!name || !email || !password) {
      alert("Please fill in all fields");
      return;
    }
    
    const signupBtn = document.getElementById("signupBtn");
    signupBtn.disabled = true;
    signupBtn.textContent = "Creating account...";
    
    try {
      console.log("Creating user with Firebase...");
      const cred = await auth.createUserWithEmailAndPassword(email, password);
      console.log("User created successfully:", cred.user.uid);
      
      console.log("Updating profile...");
      await cred.user.updateProfile({ displayName: name });
      await cred.user.reload();                    // â¬… refresh cached user
      console.log("Profile updated successfully");
      
      console.log("Getting ID token...");
      const idToken = await cred.user.getIdToken(true);
      console.log("ID token obtained");
      
      console.log("Creating server session...");
      const res = await fetch("/auth/session", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ idToken })
      });
      
      if (!res.ok) {
        const errorData = await res.json();
        throw new Error(`Server session failed: ${errorData.detail || res.statusText}`);
      }
      
      console.log("Server session created successfully");
      console.log("Redirecting to home page...");
      window.location.href = "{{ url_for('web.home') }}";
      
    } catch (e) {
      console.error("Signup error:", e);
      signupBtn.disabled = false;
      signupBtn.textContent = "Create account";
      alert("Signup failed: " + e.message);
    }
  });
</script>
{% endblock %}
